services:
  nginx:
    image: nginx:stable-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/certs:/etc/letsencrypt # Mount for Certbot certificates
      - ./apps/admin/dist:/var/www/certbot # Mount for Certbot webroot challenge
    networks:
      - app-network
    depends_on:
      - admin
      - backend
      - face-service
      - n8n

  certbot:
    image: certbot/certbot
    volumes:
      - ./nginx/certs:/etc/letsencrypt
      - ./apps/admin/dist:/var/www/certbot
    depends_on:
      - nginx
    command: "certonly --webroot -w /var/www/certbot -d family.thaohk.com -d family-api.thaohk.com --email thao.hk90@gmail.com --agree-tos --no-eff-email --force-renewal"
    networks:
      - app-network

  mysql:
    image: mysql:8.0
    container_name: family-tree-mysql-prod
    env_file:
      - ./.env
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - app-network
    restart: unless-stopped

  backend:
    image: hkthao/family-tree-backend:latest
    platform: linux/amd64
    container_name: family-tree-backend-prod
    env_file:
      - ./.env
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - CONNECTION_STRINGS_DEFAULT_CONNECTION=${CONNECTION_STRINGS_DEFAULT_CONNECTION}
      - ASPNETCORE_URLS=${ASPNETCORE_URLS}
      - JWT_SETTINGS_AUTHORITY=${JWT_SETTINGS_AUTHORITY}
      - JWT_SETTINGS_AUDIENCE=${JWT_SETTINGS_AUDIENCE}
      - JWT_SETTINGS_NAMESPACE=${JWT_SETTINGS_NAMESPACE}
      - STORAGE_SETTINGS_PROVIDER=${STORAGE_SETTINGS_PROVIDER}
      - STORAGE_SETTINGS_BASE_URL=${STORAGE_SETTINGS_BASE_URL}
      - STORAGE_SETTINGS_MAX_FILE_SIZE_MB=${STORAGE_SETTINGS_MAX_FILE_SIZE_MB}
      - STORAGE_SETTINGS_LOCAL_LOCAL_STORAGE_PATH=${STORAGE_SETTINGS_LOCAL_LOCAL_STORAGE_PATH}
      - STORAGE_SETTINGS_LOCAL_BASE_URL=${STORAGE_SETTINGS_LOCAL_BASE_URL}
      - STORAGE_SETTINGS_CLOUDINARY_CLOUD_NAME=${STORAGE_SETTINGS_CLOUDINARY_CLOUD_NAME}
      - STORAGE_SETTINGS_CLOUDINARY_API_KEY=${STORAGE_SETTINGS_CLOUDINARY_API_KEY}
      - STORAGE_SETTINGS_CLOUDINARY_API_SECRET=${STORAGE_SETTINGS_CLOUDINARY_API_SECRET}
      - STORAGE_SETTINGS_S3_BUCKET_NAME=${STORAGE_SETTINGS_S3_BUCKET_NAME}
      - STORAGE_SETTINGS_S3_ACCESS_KEY=${STORAGE_SETTINGS_S3_ACCESS_KEY}
      - STORAGE_SETTINGS_S3_SECRET_KEY=${STORAGE_SETTINGS_S3_SECRET_KEY}
      - STORAGE_SETTINGS_S3_REGION=${STORAGE_SETTINGS_S3_REGION}
      - FACE_DETECTION_SETTINGS_BASE_URL=${FACE_DETECTION_SETTINGS_BASE_URL}
      - NOTIFICATION_SETTINGS_PROVIDER=${NOTIFICATION_SETTINGS_PROVIDER}
      - NOVU_SETTINGS_API_KEY=${NOVU_SETTINGS_API_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - USE_IN_MEMORY_DATABASE=${USE_IN_MEMORY_DATABASE}
      - N8N_SETTINGS_CHAT_WEBHOOK_URL=${N8N_SETTINGS_CHAT_WEBHOOK_URL}
      - N8N_SETTINGS_EMBEDDING_WEBHOOK_URL=${N8N_SETTINGS_EMBEDDING_WEBHOOK_URL}
    depends_on:
      - mysql
    volumes:
      - backend-dataprotection-keys:/root/.aspnet/DataProtection-Keys
    networks:
      - app-network
    restart: unless-stopped

  admin:
    build:
      context: ./apps/admin
      dockerfile: Dockerfile
    container_name: family-tree-admin-prod
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}
      - VITE_AUTH0_DOMAIN=${VITE_AUTH0_DOMAIN}
      - VITE_AUTH0_CLIENT_ID=${VITE_AUTH0_CLIENT_ID}
      - VITE_AUTH0_AUDIENCE=${VITE_AUTH0_AUDIENCE}
      - VITE_NOVU_APPLICATION_IDENTIFIER=${VITE_NOVU_APPLICATION_IDENTIFIER}
      - VITE_APP_BUILD_DATE=${VITE_APP_BUILD_DATE}
      - VITE_APP_ENVIRONMENT=${VITE_APP_ENVIRONMENT}
      - VITE_APP_COMMIT_ID=${VITE_APP_COMMIT_ID}
    depends_on:
      - backend
    networks:
      - app-network
    restart: unless-stopped

  face-service:
    image: hkthao/family-tree-face-service:latest
    platform: linux/amd64
    container_name: family-tree-face-service-prod
    env_file:
      - ./.env
    environment:
      - PYTHONUNBUFFERED=1
      - DLIB_PREDICTOR_PATH=app/models/shape_predictor_68_face_landmarks.dat
      - DLIB_ENCODER_PATH=app/models/dlib_face_recognition_resnet_model_v1.dat
      - PORT=${FACE_SERVICE_PORT}
    mem_limit: 2g
    volumes:
      - face_service_models:/app/models
    networks:
      - app-network
    restart: unless-stopped

  n8n:
    image: n8nio/n8n
    container_name: family-tree-n8n-prod
    env_file:
      - ./.env
    environment:
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${N8N_HOST}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  mysql-data:
  backend-dataprotection-keys:
  n8n-data:
  face_service_models:
